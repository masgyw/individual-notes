# Zookeeper

## 1 什么是Zookeeper  
定义：开源的分布式协调服务，可以管理集群，监控集群中各个节点的状态，提供高性能、高稳定性的系统给用户。  
目的：为分布式系统提供数据发布/订阅、分布式锁、注册中心、集群管理、Master选举等功能
## 2 Zookeeper提供了什么  
1）文件系统  
2）通知机制
## 3 Zookeeper文件系统  
1）结构：多层级的节点命名空间，与文件系统不同，文件系统只能在文件节点存储数据，zk 的节点都可以存储数据。  
2）存储：节点树存储在内存中，不能存储大量数据，上限为1M，保证高吞吐和低延迟。
## 4 ZAB协议
ZAB（Zookeeper Atomic Broadcast），为zk 专门设计的支持崩溃恢复的原子广播协议，支持两种模式：崩溃恢复模式和消息广播模式。  
崩溃模式：zk集群刚刚启动、Leader服务器宕机、重启或网络故障灯原因导致集群不存在过半服务器可用，所有服务器进入崩溃恢复模式，选举新的leader服务器，follwer服务器开始与Leader服务器进行数据同步，完成之后进入消息广播模式。  
消息广播模式：leader服务器接收客户端请求，完成事务请求。  
Zxid：zab协议中事务消息的事务编号，Zxid 64位，高32位是时钟周期，低32位是事务唯一性标识。  
ZAB节点三种状态：leading 协调事务、following 服从leading、looking选举状态
## 5 zk 有哪些节点类型  
1）持久节点：节点一直存储在zk上  
2）临时节点：节点和客户端会话绑定，会话无效时，所有与会话相关的临时节点都会删除  
3）持久顺序节点：追加由父节点维护的自增序号  
4）临时顺序节点：追加由父节点维护的自增序号  
## 6 zk Watcher机制 —— 数据变更通知  
- 什么是Watcher：  
zk允许客户端向服务端某个znode注册一个Watcher监听，当服务端指定事件触发了Watcher，服务端会向指定客户端发送事件通知来实现分布式的通知，客户端进行业务上的变化。  
- 工作机制：  
1）客户端注册Watcher  
2）服务端处理Watcher  
3）客户端回调Watcher  
- 特点：  
1）一次性：触发后直接删除，3.6.0默认递归触发多次  
2）客户端回调串行工作  
3）轻量：只会告诉客户端发生了什么事件，不会有具体内容；事件注册，客户端不会把整个Watcher 发送给服务端；  
4）注册事件：exists/getData/getChildren  
5）触发事件：create/delete/setData  
## 7 客户端注册Watcher的过程  
1）调用事件注册API，传入Watcher对象  
2）标记Request，封装Watcher 到WatcherRegistration  
3）封装Packet对象，给服务端发送Watcher  
4）收到服务端响应，将Watcher注册到ZKWatcherManager中进行管理  
5）请求返回，完成注册  
## 8 服务端处理Watcher的过程  
1. 服务端接收Watcher并存储：存储在WatcherManager的WatcherTable和watch2Paths中  
2. Watcher 触发（以服务端接收到setData()事件触发NodeDataChanged事件为例）  
    1. 封装WatcherEvent：包含通知状态、事件类型、节点路径  
    2. 查询Watcher：从WatcherTable中查找Watcher  
    3. 未找到：客户端没有注册不处理  
    4. 找到：从WatcherTable和watch2Paths中提取并删除  
3. 调用Process方法来触发Watcher：通过TCP连接发送事件通知给客户端  
## 9 客户端回调Watcher  
客户端SendThread线程接收事件通知，交由EventThread线程回调Watcher,仅执行一次  
## 10 ACL 权限控制机制  
UGO（User/group/others）：Linux、Unix使用最广泛的权限控制方式。  
ACL（Access Control List）访问控制列表，包含如下三个方面：  
1）权限模式：  
（1）IP：从 IP 地址粒度进行权限控制  
（2）Digest：最常用，用类似于 username:password 的权限标识来进行权限配置，便于区分不同应用来进行权限控制  
（3）World：最开放的权限控制方式，是一种特殊的 digest 模式，只有一个权限标识“world:anyone”  
（4）Super：超级用户  
2）授权对象：  授权对象指的是权限赋予的用户或一个指定实体  
3）权限：  
（1）CREATE：数据节点创建权限，允许授权对象在该 Znode 下创建子节点  
（2）DELETE：子节点删除权限，允许授权对象删除该数据节点的子节点  
（3）READ：数据节点的读取权限，允许授权对象访问该数据节点并读取其数据内容或子节点列表等  
（4）WRITE：数据节点更新权限，允许授权对象对该数据节点进行更新操作  
（5）ADMIN：数据节点管理权限，允许授权对象对该数据节点进行 ACL 相关设置操作  
## 11. Chroot 特性  
允许每个客户端为自己设置一个命名空间，对服务器的所有操作，都在自己的命名空间下。
目的：设置Chroot，能够将客户端应用于Zk服务端的一颗子树相对应，对于多个服务通过一个Zookeeper进群的场景下，chroot有利于服务隔离。  
## 12. 会话管理  
分桶策略：将类似的会话放在同一区块中进行管理，有利于不同区块隔离和统一处理  
分配原则：每个会话的下次超时时间点  
## 13. 服务器角色  
1）leader：  
1-1）事务请求的唯一调度和处理者，保证集群事务处理的顺序性  
1-2）集群内部各服务的调度者  
2）follower：  
2-1）处理客户端的非事务请求，发送事务请求给leader  
2-2）参与事务请求的Proposal的投票  
2-3）参与leader选举  
3）Observer：  
3-1）提升非事务的请求处理能力，和follower类似  
3-2）不参与任何投票和选举  
## 14. Zk 有哪些服务状态  
四种：Looking、Following、Leading、Observing  
1）Looking:寻找leader状态  
2）Following：跟随者状态，当前服务器是Follower  
3）Leading：领导者状态，当前服务器是Leader  
4）Observing：观察者状态，当前服务器是Observer  
## 15. zk服务器之间数据如何同步  
整个集群Leader选举完成后，Follower和Observer向Leader注册，注册完成后，进行数据同步。  
1）同步流程：  
1-1）Follower和Observer向Leader注册  
1-2）数据同步  
1-3）数据确认  
2）同步类型：  
（1）直接差异化同步（DIFF 同步）  
（2）先回滚再差异化同步（TRUNC+DIFF 同步）  
（3）仅回滚同步（TRUNC 同步）  
（4）全量同步（SNAP 同步）  
3）同步场景？？  
## 16. ZK 如何保证事务的顺序一致性  
全局递增事务ID，所有proposal在提出时都会有zxid，依据XA 要求，首先会向其他的server发出事务执行请求，超过半数的机器能执行并成功，那么开始执行。  
## 17. 分布式集群中为什么会有Master  
在分布式环境中，有些业务往往只能执行一次，例如支付业务，只能被一个服务器执行，其他服务器共享执行结果，这样可以减少重复计算，提高性能，所以需要leader选举，交由leader去执行，完成数据同步。  
## 18. ZK节点宕机如何处理？  
zk本身是集群，推荐3个节点。Follower节点宕机，服务可以继续执行；Leader节点宕机，可以自动选举节点作为Leader；若集群不足半数节点存活，则无法选出leader，zk集群不可用。
## 19. zk 负载均衡和nginx 的负载均衡  
1）吞吐量：nginx 优很多  
2）配置策略：zk可以调控，粒度更细；nginx只能调整权重，需要插件实现调控  
## 20. zk部署规则，集群模式  
单机、伪集群、集群模式；节点数为2N+1（n > 0）,即最少3台；  
## 21. ZK支持动态添加机器吗？  
zk集群的水平扩容不太友好，两种方式：  
1）全局重启：关闭所有zk服务器，修改配置，重新启动  
2）逐个重启：在过半存活原则下，修改每台机器的配置，并重启，服务可用；  
## 22. zk Watcher为什么不是永久的？  
1）每次数据变更，都要通知所有客户端，会给网络和服务器带来大的压力  
2）业务上，客户端不需要每一次的变更，只需要最新的即可  
## 23. zk java 客户端工具有哪些？  
zkcline 和 apache curator
## 24. chubby 是什么，和 Zookeeper比如何？  
chubby 是google 的，非开源，完全实现paxos算法；Zookeeper 使用ZAB协议，paxos算法的变种。  
## 25. ZAB协议和Paxos算法的区别？  
相同点：
（1）两者都存在一个类似于 Leader 进程的角色，由其负责协调多个 Follower 进程的运行  
（2）Leader 进程都会等待超过半数的 Follower 做出正确的反馈后，才会将一个提案进行提交  
（3）ZAB 协议中，每个 Proposal 中都包含一个 epoch 值来代表当前的 Leader周期，Paxos 中名字为
Ballot  
不同点：  
ZAB 用来构建高可用的分布式数据主备系统（Zookeeper），Paxos 是用来构建分布式一致性状态机系统。
## 26. Zk 的典型应用场景  
Zookeeper 是一个典型的发布/订阅模式的分布式数据管理与协调框架，开发人员可以使用它来进行分
布式数据的发布和订阅。  
通过对 Zookeeper 中丰富的数据节点进行交叉使用，配合 Watcher 事件通知机制，可以非常方便的构
建一系列分布式应用中年都会涉及的核心功能，如：  
ps：记住下面1-4  
（1）分布式协调/通知  
（2）元数据/配置管理  
（3）分布式锁  
（4）高可用机制【主备切换】

（5）负载均衡  
（6）命名服务  
（7）数据发布/订阅  
（8）集群管理  
（9）分布式队列  
**数据发布/订阅**  
介绍
数据发布/订阅系统，即所谓的配置中心，顾名思义就是发布者发布数据供订阅者进行数据订阅。
目的
1）动态获取数据（配置信息）  
2）实现数据（配置信息）的集中式管理和数据的动态更新  
设计模式  
1）Push 模式  2）Pull 模式  
数据（配置信息）特性  
（1）数据量通常比较小  
（2）数据内容在运行时会发生动态更新  
（3）集群中各机器共享，配置一致  
如：机器列表信息、运行时开关配置、数据库配置信息等  
基于 Zookeeper 的实现方式  
· 数据存储：将数据（配置信息）存储到 Zookeeper 上的一个数据节点  
· 数据获取：应用在启动初始化节点从 Zookeeper 数据节点读取数据，并在该节点上注册一个数据变更
Watcher  
· 数据变更：当变更数据时，更新 Zookeeper 对应节点数据，Zookeeper会将数据变更通知发到各客户
端，客户端接到通知后重新读取变更后的数据即可。  
**负载均衡**  
zk 的命名服务  
命名服务是指通过指定的名字来获取资源或者服务的地址，利用 zk 创建一个全局的路径，这个路径就
可以作为一个名字，指向集群中的集群，提供的服务的地址，或者一个远程的对象等等。  
**分布式通知和协调**  
对于系统调度来说：操作人员发送通知实际是通过控制台改变某个节点的状态，然后 zk 将这些变化发
送给注册了这个节点的 watcher 的所有客户端。  
对于执行情况汇报：每个工作进程都在某个目录下创建一个临时节点。并携带工作的进度数据，这样汇
总的进程可以监控目录子节点的变化获得工作进度的实时的全局情况。  
**zk 的命名服务（文件系统）**  
命名服务是指通过指定的名字来获取资源或者服务的地址，利用 zk 创建一个全局的路径，即是唯一的
路径，这个路径就可以作为一个名字，指向集群中的集群，提供的服务的地址，或者一个远程的对象等
等。  
**zk 的配置管理（文件系统、通知机制）**  
程序分布式的部署在不同的机器上，将程序的配置信息放在 zk 的 znode 下，当有配置发生改变时，也
就是 znode 发生变化时，可以通过改变 zk 中某个目录节点的内容，利用 watcher 通知给各个客户端，
从而更改配置。  
**Zookeeper 集群管理（文件系统、通知机制）**  
所谓集群管理无在乎两点：是否有机器退出和加入、选举 master。  
对于第一点，所有机器约定在父目录下创建临时目录节点，然后监听父目录节点
的子节点变化消息。一旦有机器挂掉，该机器与 zookeeper 的连接断开，其所创建的临时目录节点被
删除，所有其他机器都收到通知：某个兄弟目录被删除，于是，所有人都知道：它上船了。
新机器加入也是类似，所有机器收到通知：新兄弟目录加入，highcount 又有了，对于第二点，我们稍
微改变一下，所有机器创建临时顺序编号目录节点，每次选取编号最小的机器作为 master 就好。
**Zookeeper 分布式锁（文件系统、通知机制）**  
有了 zookeeper 的一致性文件系统，锁的问题变得容易。锁服务可以分为两类，一个是保持独占，另
一个是控制时序。  
对于第一类，我们将 zookeeper 上的一个 znode 看作是一把锁，通过 createznode的方式来实现。所
有客户端都去创建 /distribute_lock 节点，最终成功创建的那个客户端也即拥有了这把锁。用完删除掉
自己创建的 distribute_lock 节点就释放出锁。  
对于第二类， /distribute_lock 已经预先存在，所有客户端在它下面创建临时顺序编号目录节点，和选
master 一样，编号最小的获得锁，用完删除，依次方便。  
**Zookeeper 队列管理（文件系统、通知机制）**  
两种类型的队列：  
（1）同步队列，当一个队列的成员都聚齐时，这个队列才可用，否则一直等待所有成员到达。  
（2）队列按照 FIFO 方式进行入队和出队操作。  
第一类，在约定目录下创建临时目录节点，监听节点数目是否是我们要求的数目。  
第二类，和分布式锁服务中的控制时序场景基本原理一致，入列有编号，出列按编号。在特定的目录下
创建 PERSISTENT_SEQUENTIAL 节点，创建成功时Watcher 通知等待的队列，队列删除序列号最小的
节点用以消费。此场景下Zookeeper 的 znode 用于消息存储，znode 存储的数据就是消息队列中的消
息内容，SEQUENTIAL 序列号就是消息的编号，按序取出即可。由于创建的节点是持久化的，所以不必
担心队列消息的丢失问题。